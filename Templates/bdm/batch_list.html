{% extends 'bdm/base.html' %}

{% block title %}Batches | EduPro{% endblock %}

{% block extra_css %}
<style>
    /* Card & Table Styles */
    .card-custom {
        background: white; border-radius: 16px; border: none;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04); transition: transform 0.2s;
    }
    
    /* Stats Cards */
    .stat-icon-wrapper {
        width: 48px; height: 48px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem; margin-right: 15px;
    }
    .bg-soft-primary { background-color: #e0f2fe; color: #0284c7; }
    .bg-soft-warning { background-color: #fef3c7; color: #d97706; }
    
    /* Table Styling */
    .table thead th {
        background: #f8f9fa; font-size: 0.75rem; text-transform: uppercase;
        letter-spacing: 0.5px; color: #8898aa; font-weight: 700;
        border-bottom: 1px solid #e9ecef; padding: 15px 20px;
    }
    .table tbody td {
        padding: 15px 20px; vertical-align: middle;
        border-bottom: 1px solid #f0f2f5; color: #344767; font-size: 0.9rem;
    }

    /* Trainer Avatar */
    .trainer-avatar {
        width: 35px; height: 35px; border-radius: 50%;
        background: #e2e8f0; color: #475569;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 0.85rem; margin-right: 10px;
    }

    /* Badges */
    .badge-course { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
    .badge-count { background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 px-2">
    <div>
        <h4 class="fw-bold mb-1 text-dark">Batch Management</h4>
        <p class="text-muted small mb-0">Overview of running classes and allocation</p>
    </div>
    <a href="{% url 'add_batch' %}" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold">
        <i class="fas fa-plus me-2"></i> Create New Batch
    </a>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-4">
        <div class="card-custom p-4">
            <div class="d-flex align-items-center">
                <div class="stat-icon-wrapper bg-soft-primary">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <h6 class="text-muted small mb-1 fw-bold text-uppercase">Active Batches</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ batches.count }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-4">
        <div class="card-custom p-4">
            <div class="d-flex align-items-center">
                <div class="stat-icon-wrapper bg-soft-warning">
                    <i class="fas fa-user-clock"></i>
                </div>
                <div>
                    <h6 class="text-muted small mb-1 fw-bold text-uppercase">Unassigned Students</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ unassigned_students.count }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card-custom">
    <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-dark">All Batches</h6>
        
        {% if unassigned_students %}
        <button class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#assignModal">
            <i class="fas fa-user-plus me-1"></i> Quick Assign
        </button>
        {% endif %}
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-4">Batch Name</th>
                    <th>Course</th>
                    <th>Assigned Trainer</th>
                    <th class="text-center">Students</th>
                    <th>Schedule</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
<tr>
    <td class="ps-4">
        <a href="{% url 'batch_detail' batch.id %}" class="fw-bold text-decoration-none text-primary">
            {{ batch.name }}
        </a>
        
        {% if batch.time_slot %}
        <div class="small text-muted"><i class="far fa-clock me-1"></i> {{ batch.time_slot }}</div>
        {% endif %}
    </td>

    <td><span class="badge-course">{{ batch.course.name }}</span></td>
    
    <td>
        {% if batch.trainer %}
            <div class="d-flex align-items-center">
                <div class="trainer-avatar">
                    {{ batch.trainer.full_name|slice:":1" }}
                </div>
                <span class="fw-semibold text-dark">{{ batch.trainer.full_name }}</span>
            </div>
        {% else %}
            <span class="badge bg-light text-muted border">Unassigned</span>
        {% endif %}
    </td>
    
    <td class="text-center">
        <span class="badge-count">
            <i class="fas fa-users me-1"></i> {{ batch.student_count }}
        </span>
    </td>
    
    <td>
        <div class="small fw-bold text-dark">Start: {{ batch.start_date|default:"TBA" }}</div>
        <div class="small text-muted">End: {{ batch.end_date|default:"--" }}</div>
    </td>
    
    <td class="text-center">
        <a href="{% url 'batch_detail' batch.id %}" class="btn btn-light btn-sm rounded-circle text-primary shadow-sm" title="Edit">
            <i class="fas fa-pen"></i>
        </a>
    </td>
</tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="text-muted mb-2"><i class="fas fa-clipboard-list fa-3x opacity-25"></i></div>
                        <p class="text-muted fw-bold">No batches created yet.</p>
                        <a href="{% url 'add_batch' %}" class="btn btn-sm btn-primary rounded-pill">Create First Batch</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Assign Student to Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'assign_student_batch' %}">
                {% csrf_token %}
                <div class="modal-body px-4">
                    <div class="alert alert-info small border-0 bg-soft-primary text-primary mb-3">
                        <i class="fas fa-info-circle me-1"></i> Only showing unassigned students.
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted fw-bold">Select Student</label>
                        <select name="student_id" class="form-select" required>
                            <option value="">-- Choose Student --</option>
                            {% for stu in unassigned_students %}
                            <option value="{{ stu.id }}">
                                {{ stu.user.first_name }} {{ stu.user.last_name }} ({{ stu.course.name }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small text-muted fw-bold">Select Batch</label>
                        <select name="batch_id" class="form-select" required>
                            <option value="">-- Choose Batch --</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.course.name }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small">Ensure the batch course matches the student's course.</div>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Confirm Assignment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}