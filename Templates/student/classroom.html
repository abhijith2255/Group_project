{% extends 'student/base.html' %}
{% load static %}

{% block content %}

<style>
    /* --- LAYOUT & HELPERS --- */
    .scrollable-card {
        max-height: 500px;
        overflow-y: auto;
    }
    /* Scrollbar styling for the syllabus */
    .scrollable-card::-webkit-scrollbar { width: 6px; }
    .scrollable-card::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrollable-card::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }

    /* --- SCHEDULE STYLES --- */
    .schedule-row {
        border-left: 5px solid #0d6efd;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .schedule-row:hover { transform: translateX(3px); }
    .schedule-row.online { border-color: #198754; }
    .schedule-row.offline { border-color: #fd7e14; }

    /* --- MATERIAL CARD STYLES --- */
    .material-card {
        border: none; border-radius: 12px;
        background: #fff;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        height: 100%; display: flex; flex-direction: column;
    }
    .material-card:hover { transform: translateY(-5px); }
    
    .type-icon {
        width: 45px; height: 45px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; margin-right: 15px; flex-shrink: 0;
    }
    .icon-pdf { background: #ffebee; color: #c62828; }
    .icon-video { background: #e3f2fd; color: #1565c0; }
    .icon-task { background: #e8f5e9; color: #2e7d32; }

    /* --- LESSON PLAN STYLES --- */
    .timeline-item {
        position: relative;
        padding-left: 30px;
        padding-bottom: 20px;
        border-left: 2px solid #e9ecef;
    }
    .timeline-item:last-child { border-left: none; }
    
    .timeline-icon {
        position: absolute; left: -9px; top: 0;
        width: 16px; height: 16px; border-radius: 50%;
        background: white; border: 2px solid #ccc;
    }
    .timeline-item.completed .timeline-icon {
        background: #198754; border-color: #198754;
    }
    .timeline-item.completed h6 { color: #155724; text-decoration: line-through; opacity: 0.8; }
</style>

<div class="container mt-4 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark"><i class="fas fa-chalkboard-teacher text-primary"></i> My Classroom</h3>
            <p class="text-muted">Welcome back, <strong>{{ student.user.first_name }}</strong></p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>

    <div class="row">
        
        <div class="col-lg-8">
            
            <div class="mb-4">
                <h5 class="fw-bold mb-3 text-dark"><i class="far fa-calendar-alt text-warning"></i> Upcoming Classes</h5>
                
                {% for class in schedule %}
                <div class="card mb-3 schedule-row {% if class.mode == 'Online' %}online{% else %}offline{% endif %}">
                    <div class="card-body py-3 d-flex align-items-center flex-wrap">
                        
                        <div class="me-3 text-center bg-light p-2 rounded border">
                            <h6 class="fw-bold mb-0 text-dark">{{ class.start_time|date:"H:i" }}</h6>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ class.start_time|date:"d M" }}</small>
                        </div>

                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">{{ class.subject }}</h6>
                            <p class="text-muted mb-0 small">
                                <i class="fas fa-user-tie"></i> {{ class.trainer.user.first_name }} 
                                <span class="mx-2">|</span> 
                                {% if class.mode == 'Online' %}
                                    <span class="text-success fw-bold">Online</span>
                                {% else %}
                                    <span class="text-warning fw-bold">Room: {{ class.room_number }}</span>
                                {% endif %}
                            </p>
                        </div>

                        <div class="mt-2 mt-md-0">
                            {% if class.mode == 'Online' and class.meeting_link %}
                                <a href="{{ class.meeting_link }}" target="_blank" class="btn btn-success btn-sm fw-bold shadow-sm">
                                    Join <i class="fas fa-video"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-light border text-center text-muted p-3">
                    <small>No upcoming classes scheduled.</small>
                </div>
                {% endfor %}
            </div>

            <div>
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-bold text-dark"><i class="fas fa-folder-open text-info"></i> Study Resources</h5>
                    <span class="badge bg-light text-dark border">{{ materials.count }} Files</span>
                </div>
                
                <div class="row">
                    {% for item in materials %}
                    <div class="col-md-6 mb-4">
                        <div class="material-card p-3">
                            <div class="d-flex align-items-start mb-2">
                                {% if item.type == 'Video' %}
                                    <div class="type-icon icon-video"><i class="fas fa-play"></i></div>
                                {% elif item.type == 'Assignment' %}
                                    <div class="type-icon icon-task"><i class="fas fa-clipboard-check"></i></div>
                                {% else %}
                                    <div class="type-icon icon-pdf"><i class="fas fa-file-alt"></i></div>
                                {% endif %}
                                
                                <div>
                                    <span class="badge bg-light text-secondary border mb-1" style="font-size: 0.7rem;">{{ item.topic }}</span>
                                    <h6 class="fw-bold mb-1 text-truncate" style="max-width: 200px;">{{ item.title }}</h6>
                                    <small class="text-muted" style="font-size: 0.75rem;">{{ item.created_at|timesince }} ago</small>
                                </div>
                            </div>

                            <div class="mt-auto pt-2">
                                {% if item.file %}
                                    <a href="{{ item.file.url }}" target="_blank" class="btn btn-outline-secondary btn-sm w-100">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                {% endif %}
                                {% if item.link %}
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                                        <i class="fas fa-external-link-alt"></i> Open Link
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">No materials uploaded yet.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>

        <div class="col-lg-4">
            
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
                <div class="card-header bg-white border-bottom p-3">
                    <h6 class="fw-bold mb-0 text-dark">
                        <i class="fas fa-tasks text-primary"></i> Course Progress
                    </h6>
                </div>
                <div class="card-body p-3">
                    
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span>{{ progress_percent }}% Completed</span>
                        <span class="text-muted">{{ completed_ids|length }} / {{ syllabus.count }} Topics</span>
                    </div>
                    <div class="progress mb-4" style="height: 10px; border-radius: 5px;">
                        <div class="progress-bar bg-primary" style="width: {{ progress_percent }}%;"></div>
                    </div>

                    <div class="scrollable-card pe-2">
                        {% for topic in syllabus %}
                            
                            {% if topic.id in completed_ids %}
                                <div class="timeline-item completed">
                                    <div class="timeline-icon"></div>
                                    <h6 class="mb-0 small fw-bold">{{ topic.topic }}</h6>
                                    <small class="text-muted" style="font-size: 0.7rem;">{{ topic.unit_name }}</small>
                                </div>
                            {% else %}
                                <div class="timeline-item">
                                    <div class="timeline-icon"></div>
                                    <h6 class="mb-0 small text-dark">{{ topic.topic }}</h6>
                                    <small class="text-muted" style="font-size: 0.7rem;">{{ topic.unit_name }}</small>
                                </div>
                            {% endif %}

                        {% empty %}
                            <div class="text-center text-muted small py-3">
                                Syllabus not available.
                            </div>
                        {% endfor %}
                    </div>

                </div>
            </div>

        </div>

    </div>
</div>

{% endblock %}