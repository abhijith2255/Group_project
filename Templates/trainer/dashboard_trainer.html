{% extends 'trainer/base.html' %}
{% load static %}

{% block title %}Instructor Dashboard | StudyLab{% endblock %}

{% block extra_css %}
<style>
    /* Custom Dashboard Styling */
    .dashboard-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%);
        color: white;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
    }
    
    /* Subtle texture overlay */
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .glass-stat {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        transition: transform 0.2s;
    }
    .glass-stat:hover { transform: translateY(-3px); }

    .batch-card {
        border: none;
        border-radius: 16px;
        background: #fff;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .batch-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .progress-slim { height: 8px; border-radius: 4px; background-color: #e9ecef; }
    
    /* Pulsing Dot for Pending Actions */
    .pulse-dot {
        width: 10px; height: 10px;
        background-color: #dc3545;
        border-radius: 50%;
        display: inline-block;
        animation: pulse-animation 2s infinite;
    }
    @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>
{% endblock %}

{% block content %}

<div class="row mb-5">
    <div class="col-12">
        <div class="p-4 p-md-5 dashboard-header shadow-lg">
            <div class="row align-items-center position-relative" style="z-index: 2;">
                <div class="col-lg-8 d-flex align-items-center mb-4 mb-lg-0">
                    <div class="position-relative me-4">
                        {% if trainer.profile_image %}
                            <img src="{{ trainer.profile_image.url }}" class="rounded-circle border border-3 border-white shadow" style="width: 90px; height: 90px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-white text-primary d-flex justify-content-center align-items-center shadow" style="width: 90px; height: 90px; font-size: 32px; font-weight: bold;">
                                {{ trainer.full_name|slice:":1" }}
                            </div>
                        {% endif %}
                        <div class="position-absolute bottom-0 end-0 bg-success border border-2 border-white rounded-circle p-2"></div>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-1">Welcome back, {{ trainer.full_name }}!</h2>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-briefcase me-2"></i>{{ trainer.designation }} &bull; {{ trainer.expertise }}
                        </p>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="d-flex gap-3 justify-content-lg-end">
                        <div class="glass-stat p-3 text-center min-w-100">
                            <h3 class="fw-bold mb-0">{{ total_batches }}</h3>
                            <small class="text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">Batches</small>
                        </div>
                        <div class="glass-stat p-3 text-center min-w-100">
                            <h3 class="fw-bold mb-0">{{ total_students }}</h3>
                            <small class="text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">Students</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-end mb-4 px-2">
    <div>
        <h4 class="fw-bold text-dark mb-1">Active Classrooms</h4>
        <p class="text-muted small mb-0">Manage daily progress and attendance.</p>
    </div>
    <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
        <i class="far fa-calendar-alt me-2 text-primary"></i>Today: {{ today|date:"M d, Y" }}
    </span>
</div>

{% if dashboard_data %}
<div class="row g-4">
    {% for item in dashboard_data %}
    <div class="col-lg-6 col-xl-4">
        <div class="batch-card h-100 d-flex flex-column">
            
            <div class="p-4 border-bottom border-light">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <span class="badge bg-primary bg-opacity-10 text-primary fw-bold px-3 py-2 rounded-pill">
                        {{ item.batch.course.name }}
                    </span>
                    {% if not item.is_attendance_marked %}
                        <div class="d-flex align-items-center text-danger small fw-bold" title="Attendance Needed">
                            <span class="pulse-dot me-2"></span> Action
                        </div>
                    {% else %}
                        <i class="fas fa-check-circle text-success fs-5"></i>
                    {% endif %}
                </div>
                <h5 class="fw-bold text-dark mb-1">{{ item.batch.name }}</h5>
                <small class="text-muted">
                    <i class="far fa-clock me-1"></i> {{ item.batch.time_slot|default:"Standard Time" }}
                </small>
            </div>

            <div class="p-4 flex-grow-1">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-light rounded-circle p-2 me-3 text-primary">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-0">{{ item.student_count }} Students</h6>
                        <small class="text-muted">Enrolled</small>
                    </div>
                </div>

                <div class="mb-2">
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span class="text-secondary">Syllabus Completion</span>
                        <span class="text-primary">{{ item.progress }}%</span>
                    </div>
                    <div class="progress progress-slim">
                        <div class="progress-bar {% if item.progress < 40 %}bg-warning{% else %}bg-success{% endif %}" 
                             role="progressbar" 
                             style="width: {{ item.progress }}%">
                        </div>
                    </div>
                    <div class="text-end mt-1">
                        <small class="text-muted" style="font-size: 0.75rem;">{{ item.completed_topics }} / {{ item.total_topics }} Topics</small>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-light bg-opacity-25 rounded-bottom-4 border-top border-light">
                <div class="row g-2">
                    <div class="col-6">
                        <a href="{% url 'batch_students' item.batch.id %}" class="btn btn-white border w-100 fw-bold text-secondary shadow-sm">
                            <i class="fas fa-cog me-1"></i> Manage
                        </a>
                    </div>
                    
                    <div class="col-6">
                        {% if item.is_attendance_marked %}
                            <button class="btn btn-success w-100 fw-bold text-white shadow-sm" disabled style="opacity: 0.8;">
                                <i class="fas fa-check me-1"></i> Done
                            </button>
                        {% else %}
                            <a href="#" class="btn btn-danger w-100 fw-bold shadow-sm">
                                Mark <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <div class="mb-3 opacity-25">
        <i class="fas fa-laptop-house fa-4x text-muted"></i>
    </div>
    <h4 class="text-muted">No batches assigned yet</h4>
    <p class="text-secondary">Contact the admin to get assigned to a course.</p>
</div>
{% endif %}

{% endblock %}